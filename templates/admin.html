<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المشرف | Vees</title>
            <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/mazen-alqayser/Air-Ticket-Reservation-dr-anas-project/refs/heads/main/ChatGPT%20Image%20Oct%205%2C%202025%2C%2005_35_52%20PM%20-%20Copy.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        input[dir="ltr"] { text-align: left; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .toast-message {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .toast-message.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">

    <div id="admin-login-container" class="flex flex-col items-center justify-center min-h-screen w-full">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">تسجيل دخول المشرف</h1>
            <p class="text-gray-600 mb-6">الرجاء إدخال البريد الإلكتروني وكلمة المرور للوصول إلى لوحة التحكم.</p>
            <form id="admin-login-form">
                <div class="mb-4">
                    <input type="email" id="admin-email-input" placeholder="البريد الإلكتروني" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr">
                </div>
                <div class="mb-6">
                    <input type="password" id="admin-password-input" placeholder="كلمة المرور" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr">
                </div>
                <p id="auth-message" class="text-red-500 mb-4 hidden"></p>
                <button type="submit" id="login-btn" class="w-full px-4 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden w-full max-w-6xl">
        <header class="bg-white shadow-lg rounded-lg p-6 mb-8 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">لوحة تحكم المشرف</h1>
            <div class="flex items-center space-x-2 space-x-reverse">
                <button id="view-deleted-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-200">عرض الحسابات المحذوفة</button>
                <button id="admin-logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">تسجيل الخروج</button>
            </div>
        </header>

        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <input type="text" id="search-input" placeholder="ابحث بالاسم أو اسم الشركة..." class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-right" dir="rtl">
        </div>

        <main class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div id="total-users-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl transition-shadow duration-200">
                <h2 class="text-xl font-bold text-gray-800">إجمالي المستخدمين</h2>
                <p id="total-users" class="text-4xl font-extrabold text-blue-500 mt-2">0</p>
            </div>
            <div id="active-users-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl transition-shadow duration-200">
                <h2 class="text-xl font-bold text-gray-800">المستخدمون النشطون</h2>
                <p id="active-users" class="text-4xl font-extrabold text-green-500 mt-2">0</p>
            </div>
            <div id="suspended-users-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl transition-shadow duration-200">
                <h2 class="text-xl font-bold text-gray-800">المستخدمون الموقوفون</h2>
                <p id="suspended-users" class="text-4xl font-extrabold text-orange-500 mt-2">0</p>
            </div>
            <div id="pending-users-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl transition-shadow duration-200">
                <h2 class="text-xl font-bold text-gray-800">طلبات جديدة</h2>
                <p id="pending-users" class="text-4xl font-extrabold text-yellow-500 mt-2">0</p>
            </div>
        </main>

        <div class="bg-white rounded-xl shadow-md p-6 mt-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">إدارة المستخدمين</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                اسم الشركة
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                اسم المالك
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                البريد الإلكتروني
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                البلد
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                الحالة
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                الإجراءات
                            </th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="user-details-modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">تفاصيل المستخدم</h2>
                <button id="close-details-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            </div>
            <div id="modal-content" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="edit-user-modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">تعديل معلومات المستخدم</h2>
                <button id="close-edit-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            </div>
            <form id="edit-user-form" class="space-y-4">
                <div>
                    <label for="edit-email" class="block text-gray-700">البريد الإلكتروني الجديد</label>
                    <input type="email" id="edit-email" class="w-full mt-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr">
                </div>
                <div>
                    <label for="edit-password" class="block text-gray-700">كلمة المرور الجديدة</label>
                    <input type="password" id="edit-password" class="w-full mt-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr">
                </div>
                <div class="flex justify-end space-x-2 space-x-reverse">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center relative">
            <h2 id="confirmation-title" class="text-2xl font-bold text-gray-800 mb-4">هل أنت متأكد؟</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">سيتم حذف الحساب بشكل مؤقت.</p>
            <div class="flex justify-center space-x-4 space-x-reverse">
                <button id="confirm-action-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">تأكيد</button>
                <button id="cancel-action-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-200">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="toast-message" class="toast-message"></div>

    <script>
        // DOM elements
        const adminLoginContainer = document.getElementById('admin-login-container');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminEmailInput = document.getElementById('admin-email-input');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const authMessage = document.getElementById('auth-message');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const totalUsersEl = document.getElementById('total-users');
        const activeUsersEl = document.getElementById('active-users');
        const suspendedUsersEl = document.getElementById('suspended-users');
        const pendingUsersEl = document.getElementById('pending-users');
        const usersTableBody = document.getElementById('users-table-body');
        const userDetailsModal = document.getElementById('user-details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const modalContent = document.getElementById('modal-content');
        const totalUsersCard = document.getElementById('total-users-card');
        const activeUsersCard = document.getElementById('active-users-card');
        const suspendedUsersCard = document.getElementById('suspended-users-card');
        const pendingUsersCard = document.getElementById('pending-users-card');
        const searchInput = document.getElementById('search-input');
        const viewDeletedBtn = document.getElementById('view-deleted-btn');
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editUserForm = document.getElementById('edit-user-form');
        const editEmailInput = document.getElementById('edit-email');
        const editPasswordInput = document.getElementById('edit-password');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelActionBtn = document.getElementById('cancel-action-btn');

        let allUsers = [];
        let currentUserId = null;
        let isShowingDeleted = false;

        // Toast message function
        function showToast(message) {
            const toast = document.getElementById('toast-message');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }
        
        // Modal functions
        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }

        const fetchAndRenderUsers = async () => {
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) throw new Error('فشل في جلب بيانات المستخدمين.');
                
                const data = await response.json();
                allUsers = data;

                renderSummary(data.filter(u => u.status !== 'محذوف مؤقتاً'));
                if (isShowingDeleted) {
                    renderDeletedUsers();
                } else {
                    filterAndRender(null);
                }
            } catch (error) {
                console.error("Error fetching users: ", error);
                showToast("حدث خطأ في جلب بيانات المستخدمين.");
            }
        };

        const renderSummary = (users) => {
            const activeUsersCount = users.filter(user => user.status === 'active').length;
            const suspendedUsersCount = users.filter(user => user.status === 'suspended').length;
            const pendingUsersCount = users.filter(user => user.status === 'pending').length;
            totalUsersEl.textContent = users.length;
            activeUsersEl.textContent = activeUsersCount;
            suspendedUsersEl.textContent = suspendedUsersCount;
            pendingUsersEl.textContent = pendingUsersCount;
        };

        const renderTable = (users) => {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100';
                
                let actionsHtml = `<button onclick="window.viewUser(${user.id})" class="text-blue-600 hover:text-blue-900 font-medium ml-2">عرض</button>`;
                
                if (isShowingDeleted) {
                    actionsHtml = `
                        <button onclick="window.restoreUser(${user.id})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-sm">استعادة</button>
                        <button onclick="window.viewUser(${user.id})" class="text-blue-600 hover:text-blue-900 font-medium mr-2">عرض</button>
                    `;
                } else if (user.status === 'pending' || user.status === 'rejected') {
                    actionsHtml = `
                        <button onclick="window.acceptUser(${user.id})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-sm">قبول</button>
                        <button onclick="window.rejectUser(${user.id})" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm mr-2">رفض</button>
                        <button onclick="window.viewUser(${user.id})" class="text-blue-600 hover:text-blue-900 font-medium">عرض</button>
                    `;
                } else {
                    actionsHtml = `
                        <button onclick="window.viewUser(${user.id})" class="text-blue-600 hover:text-blue-900 font-medium ml-2">عرض</button>
                        <button onclick="window.toggleUserStatus(${user.id}, '${user.status}')" class="text-yellow-600 hover:text-yellow-900 font-medium ml-2">${user.status === 'active' ? 'إيقاف' : 'تفعيل'}</button>
                        <button onclick="window.promptDeleteUser(${user.id})" class="text-red-600 hover:text-red-900 font-medium">حذف</button>
                    `;
                }

                let statusClass = '';
                switch(user.status) {
                    case 'active':
                        statusClass = 'bg-green-100 text-green-800';
                        break;
                    case 'pending':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'suspended':
                        statusClass = 'bg-orange-100 text-orange-800';
                        break;
                    case 'rejected':
                        statusClass = 'bg-red-100 text-red-800';
                        break;
                    case 'محذوف مؤقتاً':
                        statusClass = 'bg-gray-200 text-gray-800';
                        break;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.companyName || 'غير متوفر'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.ownerName || 'غير متوفر'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left" dir="ltr">${user.email || 'غير متوفر'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.country || 'غير متوفر'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${user.status || 'غير محدد'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 space-x-reverse">
                        ${actionsHtml}
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        };

        const filterAndRender = (status) => {
            let filteredUsers = allUsers.filter(u => !u.is_deleted);
            if (status) {
                filteredUsers = filteredUsers.filter(user => user.status === status);
            }
            renderTable(filteredUsers);
        };

        const searchUsers = () => {
            const query = searchInput.value.toLowerCase();
            let filteredUsers = allUsers.filter(u => !u.is_deleted);
            if (isShowingDeleted) {
                filteredUsers = allUsers.filter(u => u.is_deleted);
            }
            const results = filteredUsers.filter(user => 
                (user.ownerName && user.ownerName.toLowerCase().includes(query)) ||
                (user.companyName && user.companyName.toLowerCase().includes(query))
            );
            renderTable(results);
        };

        window.viewUser = (id) => {
            currentUserId = id;
            const user = allUsers.find(u => u.id === id);
            if (!user) {
                showToast("المستخدم غير موجود.");
                return;
            }
            
            modalContent.innerHTML = `
                <div class="space-y-3">
                    <p class="font-bold">اسم الشركة: <span class="font-normal">${user.companyName || 'غير متوفر'}</span></p>
                    <p class="font-bold">اسم المالك: <span class="font-normal">${user.ownerName || 'غير متوفر'}</span></p>
                    <p class="font-bold">البريد الإلكتروني: <span class="font-normal" dir="ltr">${user.email}</span></p>
                    <p class="font-bold">الرقم الأساسي للتواصل: <span class="font-normal" dir="ltr">${user.primaryPhone || 'غير متوفر'}</span></p>
                    <p class="font-bold">رقم إضافي: <span class="font-normal" dir="ltr">${user.secondaryPhone || 'غير متوفر'}</span></p>
                    <p class="font-bold">البلد: <span class="font-normal">${user.country || 'غير متوفر'}</span></p>
                    <p class="font-bold">العنوان: <span class="font-normal">${user.address || 'غير متوفر'}</span></p>
                    <p class="font-bold">المجال/النشاط التجاري: <span class="font-normal">${user.businessField || 'غير متوفر'}</span></p>
                    <p class="font-bold">عدد الفروع: <span class="font-normal">${user.branchesCount || 'غير متوفر'}</span></p>
                    <p class="font-bold">نوع المنتجات/الخدمات: <span class="font-normal">${user.productType || 'غير متوفر'}</span></p>
                    <p class="font-bold">عدد المستخدمين المتوقعين: <span class="font-normal">${user.expectedUsers || 'غير متوفر'}</span></p>
                    <p class="font-bold">الغرض من استخدام البرنامج: <span class="font-normal">${user.purpose || 'غير متوفر'}</span></p>
                    <p class="font-bold">كيف سمع عن البرنامج؟: <span class="font-normal">${user.howHeard || 'غير متوفر'}</span></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="font-bold text-lg mb-2">إدارة الحساب</h3>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 sm:space-x-reverse">
                        <button onclick="window.toggleUserStatus(${user.id}, '${user.status}')" class="flex-1 bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition-colors duration-200">
                            ${user.status === 'active' ? 'إيقاف الحساب' : 'تفعيل الحساب'}
                        </button>
                        <button onclick="window.promptDeleteUser(${user.id})" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                            حذف الحساب
                        </button>
                        <button onclick="window.showEditUserModal(${user.id})" class="flex-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                            تعديل
                        </button>
                    </div>
                </div>
            `;
            showModal(userDetailsModal);
        };

        window.toggleUserStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            try {
                const response = await fetch(`/api/admin/users/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('فشل في تحديث الحالة');
                
                showToast(`تم تحديث حالة المستخدم إلى: ${newStatus}`);
                fetchAndRenderUsers();
                hideModal(userDetailsModal);
            } catch (error) {
                console.error("Error toggling user status: ", error);
                showToast("حدث خطأ أثناء تغيير حالة المستخدم.");
            }
        };

        window.acceptUser = async (id) => {
            try {
                const response = await fetch(`/api/admin/users/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'active' })
                });
                
                if (!response.ok) throw new Error('فشل في قبول المستخدم');
                
                showToast(`تم قبول المستخدم بنجاح.`);
                fetchAndRenderUsers();
            } catch (error) {
                console.error("Error accepting user: ", error);
                showToast("حدث خطأ أثناء قبول المستخدم.");
            }
        };

        window.rejectUser = async (id) => {
            try {
                const response = await fetch(`/api/admin/users/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'rejected' })
                });
                
                if (!response.ok) throw new Error('فشل في رفض المستخدم');
                
                showToast(`تم رفض المستخدم بنجاح.`);
                fetchAndRenderUsers();
            } catch (error) {
                console.error("Error rejecting user: ", error);
                showToast("حدث خطأ أثناء رفض المستخدم.");
            }
        };

        window.promptDeleteUser = (id) => {
            currentUserId = id;
            confirmationTitle.textContent = "هل أنت متأكد من الحذف؟";
            confirmationMessage.textContent = "سيتم حذف الحساب بشكل مؤقت وسيظل متاحاً للاستعادة.";
            confirmActionBtn.dataset.action = 'delete';
            confirmActionBtn.textContent = 'تأكيد الحذف';
            showModal(confirmationModal);
        };

        window.restoreUser = async (id) => {
            try {
                const response = await fetch(`/api/admin/users/${id}/restore`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) throw new Error('فشل في استعادة المستخدم');
                
                showToast(`تم استعادة المستخدم بنجاح.`);
                renderDeletedUsers();
            } catch (error) {
                console.error("Error restoring user: ", error);
                showToast("حدث خطأ أثناء استعادة المستخدم.");
            }
        };

        window.showEditUserModal = (id) => {
            currentUserId = id;
            const user = allUsers.find(u => u.id === id);
            if (!user) {
                showToast("المستخدم غير موجود.");
                return;
            }
            editEmailInput.value = user.email;
            editPasswordInput.value = '';
            hideModal(userDetailsModal);
            showModal(editUserModal);
        };

        const renderDeletedUsers = () => {
            const deletedUsers = allUsers.filter(u => u.is_deleted);
            isShowingDeleted = true;
            viewDeletedBtn.textContent = 'العودة إلى القائمة الرئيسية';
            renderTable(deletedUsers);
        };
        
        // Event Listeners
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            authMessage.classList.add('hidden');
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'فشل تسجيل الدخول');
                }
                
                adminLoginContainer.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                fetchAndRenderUsers();
            } catch (error) {
                console.error("Login error: ", error);
                authMessage.textContent = 'فشل تسجيل الدخول. تأكد من صحة البريد الإلكتروني وكلمة المرور.';
                authMessage.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                // Flask logout is handled by the server
                const response = await fetch('/logout');
                if (!response.ok) throw new Error("Logout failed");

                adminDashboard.classList.add('hidden');
                adminLoginContainer.classList.remove('hidden');
                adminEmailInput.value = '';
                adminPasswordInput.value = '';
                authMessage.classList.add('hidden');
                showToast("تم تسجيل الخروج بنجاح.");
            } catch (error) {
                console.error("Logout error: ", error);
                showToast("حدث خطأ أثناء تسجيل الخروج.");
            }
        });

        closeDetailsModalBtn.addEventListener('click', () => hideModal(userDetailsModal));
        closeEditModalBtn.addEventListener('click', () => hideModal(editUserModal));
        cancelEditBtn.addEventListener('click', () => hideModal(editUserModal));
        cancelActionBtn.addEventListener('click', () => hideModal(confirmationModal));

        confirmActionBtn.addEventListener('click', async () => {
            if (confirmActionBtn.dataset.action === 'delete' && currentUserId) {
                try {
                    const response = await fetch(`/api/admin/users/${currentUserId}/delete`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'}
                    });

                    if (!response.ok) throw new Error('فشل في حذف المستخدم');

                    showToast(`تم حذف المستخدم مؤقتاً.`);
                    fetchAndRenderUsers();
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    showToast("حدث خطأ أثناء حذف المستخدم.");
                }
            }
            hideModal(confirmationModal);
            hideModal(userDetailsModal);
        });

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newEmail = editEmailInput.value;
            const newPassword = editPasswordInput.value;
            if (!currentUserId) return;

            const updates = {};
            if (newEmail) updates.email = newEmail;
            if (newPassword) updates.password = newPassword;

            try {
                const response = await fetch(`/api/admin/users/${currentUserId}/edit`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });
                
                if (!response.ok) throw new Error('فشل في تحديث البيانات');

                showToast("تم تحديث بيانات المستخدم بنجاح.");
                fetchAndRenderUsers();
                hideModal(editUserModal);
            } catch (error) {
                console.error("Error updating user: ", error);
                showToast("حدث خطأ أثناء تحديث بيانات المستخدم.");
            }
        });

        totalUsersCard.addEventListener('click', () => filterAndRender(null));
        activeUsersCard.addEventListener('click', () => filterAndRender('active'));
        suspendedUsersCard.addEventListener('click', () => filterAndRender('suspended'));
        pendingUsersCard.addEventListener('click', () => filterAndRender('pending'));
        searchInput.addEventListener('input', searchUsers);

        viewDeletedBtn.addEventListener('click', () => {
            if (isShowingDeleted) {
                isShowingDeleted = false;
                viewDeletedBtn.textContent = 'عرض الحسابات المحذوفة';
                fetchAndRenderUsers();
            } else {
                renderDeletedUsers();
            }
        });
    </script>
</body>
</html>