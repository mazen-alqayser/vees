<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title> Vees | التقارير المالية</title>
            <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/mazen-alqayser/Air-Ticket-Reservation-dr-anas-project/refs/heads/main/ChatGPT%20Image%20Oct%205%2C%202025%2C%2005_35_52%20PM%20-%20Copy.png">

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <!-- الهيدر -->
     <header class="bg-white shadow-sm py-2 px-4 flex justify-between items-center fixed top-0 left-0 w-full z-50">
  <h1 class="mb-6 text-center text-4xl font-extrabold text-gray-700">
  <span class="text-black-600">Vees</span>
</h1>


        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="text" placeholder="بحث..." class="bg-gray-100 rounded-full px-4 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button class="text-gray-600 hover:text-blue-500 transition-colors"><i class="fas fa-bell text-lg"></i></button>
            <div class="relative">
                <img src="https://raw.githubusercontent.com/mazen-alqayser/a/refs/heads/main/527433485_4614807792079064_709098891592975352_n.jpg" alt="صورة الملف الشخصي" class="w-10 h-10 rounded-full cursor-pointer">
            </div>
        </div>
    </header>

  <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 fixed top-0 right-0 z-40 pt-20 h-full overflow-y-auto">
    <nav class="mt-4">
        <ul class="space-y-1">
            
            <li class="mb-2">
                <a href="{{ url_for('index') }}" class="flex items-center p-4 text-white bg-gray-700 transition-colors rounded-r-lg">
                    <i class="fas fa-chart-line ml-3"></i>
                    <span>الرئيسية (لوحة القيادة)</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('sales') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-cash-register ml-3"></i>
                    <span>المبيعات</span>
                </a>
            </li>
            
            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">التحليل المالي</span>
            
            <li class="mb-2">
                <a href="{{ url_for('reports') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-file-invoice-dollar ml-3"></i>
                    <span>التقارير المالية</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('profit_loss') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-chart-bar ml-3"></i>
                    <span>الأرباح والخسائر</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('comparisons') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-exchange-alt ml-3"></i>
                    <span>المقارنة اليدوية/المالية</span>
                </a>
            </li>

            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">الإدارة والعمليات</span>
            
            <li class="mb-2">
                <a href="{{ url_for('products') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-box-open ml-3"></i>
                    <span>إدارة المنتجات</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('inventory') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-boxes ml-3"></i>
                    <span>الجرد والمخزون</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('employees') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-users ml-3"></i>
                    <span>إدارة الموظفين</span>
                </a>
            </li>

            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">أدوات متقدمة</span>

            <li class="mb-2">
                <a href="{{ url_for('forecasts') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-cogs ml-3"></i>
                    <span>التوقعات والميزانية</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>


    <!-- المحتوى الرئيسي -->
    <main class="mr-64 pt-20 p-6">
        <h2 class="text-3xl font-bold text-gray-700 mb-4">التقارير المالية</h2>

        <!-- رسالة أخطاء (مرئية إذا فشل التحميل) -->
        <div id="errorBox" class="hidden mb-4 bg-red-50 border border-red-200 text-red-700 p-3 rounded"></div>

        <!-- الميزانية العمومية -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">الميزانية العمومية</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
                            <th class="py-3 px-6 text-left">الأصول</th>
                            <th class="py-3 px-6 text-left">القيمة</th>
                            <th class="py-3 px-6 text-left">الخصوم</th>
                            <th class="py-3 px-6 text-left">القيمة</th>
                        </tr>
                    </thead>
                    <tbody id="balanceSheetBody" class="text-gray-600 text-sm font-light">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- التدفقات النقدية -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">قائمة التدفقات النقدية</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
                            <th class="py-3 px-6 text-left">النشاط</th>
                            <th class="py-3 px-6 text-left">التدفق النقدي</th>
                        </tr>
                    </thead>
                    <tbody id="cashFlowBody" class="text-gray-600 text-sm font-light">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- دوال مساعدة ---
        function safeNum(x) {
            const n = Number(x);
            return Number.isFinite(n) ? n : 0;
        }

        function formatMoney(value) {
            const n = safeNum(value);
            const sign = n < 0 ? '-' : '';
            const abs = Math.abs(n);
            // ألفية الأرقام بفواصل، مع منزلتين عشرية
            const formatted = Number(abs.toFixed(2)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return sign + formatted + ' ريال';
        }

        function insertRowBalance(leftLabel, leftValue, rightLabel, rightValue) {
            return `
                <tr class="border-b hover:bg-gray-100">
                    <td class="py-3 px-6">${leftLabel}</td>
                    <td class="py-3 px-6 font-medium">${formatMoney(leftValue)}</td>
                    <td class="py-3 px-6">${rightLabel}</td>
                    <td class="py-3 px-6 font-medium">${formatMoney(rightValue)}</td>
                </tr>
            `;
        }

        function cashRow(label, value) {
            const cls = value < 0 ? 'text-red-600 font-medium' : 'text-green-600 font-medium';
            return `<tr class="border-b"><td class="py-3 px-6">${label}</td><td class="py-3 px-6 ${cls}">${formatMoney(value)}</td></tr>`;
        }

        // --- التحميل الرئيسي ---
        async function loadReports() {
            const errBox = document.getElementById('errorBox');
            errBox.classList.add('hidden');
            errBox.textContent = '';

            try {
                // 1) جلب بيانات الربح/الخسارة (يوفر total_revenue, total_cogs, total_expenses, net_profit_loss)
                const profitRes = await fetch('/api/profit_loss');
                if (!profitRes.ok) throw new Error('فشل جلب /api/profit_loss (تأكد من تسجيل الدخول).');
                const profitData = await profitRes.json();

                // استخلاص القيم الأساسية مع الحماية من null/undefined
                const totalRevenue = safeNum(profitData.total_revenue ?? profitData.total_revenue_sum ?? 0);
                const totalCogs = safeNum(profitData.total_cogs ?? 0);
                const totalExpenses = safeNum(profitData.total_expenses ?? 0);
                const netProfit = safeNum(profitData.net_profit_loss ?? profitData.net_profit ?? (totalRevenue - totalCogs - totalExpenses));

                // 2) جلب المنتجات لحساب قيمة المخزون (سعر الجملة × الكمية)
                const productsRes = await fetch('/api/products');
                if (!productsRes.ok) throw new Error('فشل جلب /api/products.');
                const products = await productsRes.json();

                const inventoryValue = products.reduce((sum, p) => {
                    const wholesale = safeNum(p.wholesale_price ?? p.cost_price ?? 0);
                    const qty = safeNum(p.quantity_in_stock ?? 0);
                    return sum + (wholesale * qty);
                }, 0);

                // 3) جلب الموظفين لحساب مجموع الرواتب
                const employeesRes = await fetch('/api/employees');
                let employees = [];
                if (employeesRes.ok) {
                    employees = await employeesRes.json();
                }
                const totalSalaries = employees.reduce((sum, e) => sum + safeNum(e.salary ?? 0), 0);

                // 4) حساب خسائر المبيعات (إذا كانت تكلفة البضاعة > الإيرادات => خسارة إجمالية)
                const salesLoss = Math.max(0, totalCogs - totalRevenue);

                // 5) تعبئة جدول الميزانية العمومية
                const balanceBody = document.getElementById('balanceSheetBody');
                const assetsCurrent = totalRevenue; // حسب تعريفك: "المبالغ التي بيعت بها"
                const assetsFixed = inventoryValue;  // قيمة المخزون (سعر الجملة × الكمية)
                const liabilitiesCurrent = salesLoss; // بيع بخسارة
                const liabilitiesNonCurrent = totalSalaries; // الرواتب

                const totalAssets = assetsCurrent + assetsFixed;
                const totalLiabilities = liabilitiesCurrent + liabilitiesNonCurrent;

                balanceBody.innerHTML = `
                    ${insertRowBalance('الأصول المتداولة', assetsCurrent, 'الخصوم المتداولة', liabilitiesCurrent)}
                    ${insertRowBalance('الأصول الثابتة (مخزون - سعر الجملة)', assetsFixed, 'الخصوم غير المتداولة (رواتب)', liabilitiesNonCurrent)}
                    <tr class="font-bold border-t">
                        <td class="py-3 px-6">إجمالي الأصول</td>
                        <td class="py-3 px-6 font-bold">${formatMoney(totalAssets)}</td>
                        <td class="py-3 px-6">إجمالي الخصوم</td>
                        <td class="py-3 px-6 font-bold">${formatMoney(totalLiabilities)}</td>
                    </tr>
                    <tr>
                        <td class="py-3 px-6">صافي الربح (من تقرير الربح والخسارة)</td>
                        <td class="py-3 px-6 font-medium">${formatMoney(netProfit)}</td>
                        <td class="py-3 px-6">مصروفات للفترة</td>
                        <td class="py-3 px-6 font-medium">${formatMoney(totalExpenses)}</td>
                    </tr>
                `;

                // 6) تعبئة جدول التدفقات النقدية (تقديري من البيانات المتاحة)
                // تشغيلية = الأصول المتداولة - الخصوم المتداولة
                const operating = assetsCurrent - liabilitiesCurrent;
                // استثمارية = تقدير مشتريات/نفقة على المخزون => نأخذ -10% من المخزون (قابل للتخصيص لاحقًا)
                const investing = -inventoryValue * 0.10;
                // تمويلية = تدفقات مرتبطة بالرواتب (نضعها سالبة لأنها مصروف)
                const financing = -liabilitiesNonCurrent;

                const cashBody = document.getElementById('cashFlowBody');
                cashBody.innerHTML = `
                    ${cashRow('التدفقات من الأنشطة التشغيلية', operating)}
                    ${cashRow('التدفقات من الأنشطة الاستثمارية', investing)}
                    ${cashRow('التدفقات من الأنشطة التمويلية', financing)}
                    <tr class="font-bold border-t">
                        <td class="py-3 px-6">صافي التدفقات (تقريبي)</td>
                        <td class="py-3 px-6 font-bold">${formatMoney(operating + investing + financing)}</td>
                    </tr>
                `;
            } catch (err) {
                console.error('خطأ في تحميل البيانات:', err);
                const errBox = document.getElementById('errorBox');
                errBox.textContent = 'حدث خطأ أثناء جلب بيانات التقارير: ' + (err.message || err);
                errBox.classList.remove('hidden');
            }
        }

        // تشغيل التحميل عند فتح الصفحة
        loadReports();
    </script>
</body>
</html>
