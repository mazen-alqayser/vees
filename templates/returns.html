<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© | Vees</title>
            <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/mazen-alqayser/Air-Ticket-Reservation-dr-anas-project/refs/heads/main/ChatGPT%20Image%20Oct%205%2C%202025%2C%2005_35_52%20PM%20-%20Copy.png">

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        #searchResults { z-index: 100; }
        .profile-menu {
            top: 100%;
            left: 0;
            transform: translateX(0%);
            z-index: 99;
        }
        /* Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ RTL Ø¹Ù„Ù‰ Ø§Ù„Ù€ Modal Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
        .modal-content {
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

  <header class="bg-white shadow-sm py-2 px-4 flex justify-between items-center fixed top-0 left-0 w-full z-50">
  <h1 class="mb-6 text-center text-4xl font-extrabold text-gray-700">
  <span class="text-black-600">Vees</span>
</h1>


        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="text" placeholder="Ø¨Ø­Ø«..." class="bg-gray-100 rounded-full px-4 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button class="text-gray-600 hover:text-blue-500 transition-colors"><i class="fas fa-bell text-lg"></i></button>
            <div class="relative">
                <img src="https://raw.githubusercontent.com/mazen-alqayser/a/refs/heads/main/527433485_4614807792079064_709098891592975352_n.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" class="w-10 h-10 rounded-full cursor-pointer">
            </div>
        </div>
    </header>

   <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 fixed top-0 right-0 z-40 pt-20 h-full overflow-y-auto">
    <nav class="mt-4">
        <ul class="space-y-1">
            
            <li class="mb-2">
                <a href="{{ url_for('index') }}" class="flex items-center p-4 text-white bg-gray-700 transition-colors rounded-r-lg">
                    <i class="fas fa-chart-line ml-3"></i>
                    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©)</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('sales') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-cash-register ml-3"></i>
                    <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                </a>
            </li>
            
            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ</span>
            
            <li class="mb-2">
                <a href="{{ url_for('reports') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-file-invoice-dollar ml-3"></i>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('profit_loss') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-chart-bar ml-3"></i>
                    <span>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('comparisons') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-exchange-alt ml-3"></i>
                    <span>Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©/Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span>
                </a>
            </li>

            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
            
            <li class="mb-2">
                <a href="{{ url_for('products') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-box-open ml-3"></i>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('inventory') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-boxes ml-3"></i>
                    <span>Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                </a>
            </li>
            <li class="mb-2">
                <a href="{{ url_for('employees') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-users ml-3"></i>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </a>
            </li>

            <hr class="border-gray-600 my-2 mx-4">
            <span class="text-xs text-gray-400 px-4 uppercase font-semibold block">Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</span>

            <li class="mb-2">
                <a href="{{ url_for('forecasts') }}" class="flex items-center p-4 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="fas fa-cogs ml-3"></i>
                    <span>Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>


    <main class="mr-64 pt-20 p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-700">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</h2>
            <button id="addNewReturnBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors flex items-center">
                <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-4">
                <div class="relative">
                    <input id="tableSearchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²..." class="w-full bg-gray-100 border-2 border-gray-200 rounded-lg py-2 px-4 pr-10 focus:outline-none focus:border-blue-500">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-right" id="returnsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø§Ù„Ø±Ù…Ø²</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø§Ù„Ø§Ø³Ù…</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù‚Ø·Ø§Ø¹ÙŠ)</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù…Ù„Ø©)</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø±ØªØ¬Ø§Ø¹</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="returnsTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="returnModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
            <div class="mt-3 text-center">
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="returnForm">
                        <input type="hidden" id="returnId" name="returnId"> <div class="mb-4">
                            <label for="imageUrl" class="block text-sm font-medium text-gray-700">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ (Ø±Ø§Ø¨Ø·)</label>
                            <input type="text" id="imageUrl" name="imageUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="productName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" id="productName" name="productName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="productCode" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø±Ù…Ø²</label>
                            <input type="text" id="productCode" name="productCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="quantity" class="block text-sm font-medium text-gray-700">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                            <input type="number" id="quantity" name="quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required min="1">
                        </div>
                        <div class="mb-4">
                            <label for="buyPrice" class="block text-sm font-medium text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¬.Ù…)</label>
                            <input type="number" step="0.01" id="buyPrice" name="buyPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="retailPrice" class="block text-sm font-medium text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù‚Ø·Ø§Ø¹ÙŠ) (Ø¬.Ù…)</label>
                            <input type="number" step="0.01" id="retailPrice" name="retailPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="wholesalePrice" class="block text-sm font-medium text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù…Ù„Ø©) (Ø¬.Ù…)</label>
                            <input type="number" step="0.01" id="wholesalePrice" name="wholesalePrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="reason" class="block text-sm font-medium text-gray-700">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø±ØªØ¬Ø§Ø¹</label>
                            <textarea id="reason" name="reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveReturnBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Ø­ÙØ¸</button>
                    <button id="closeModalBtn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">Ø­Ø°Ù</button>
                    <button id="cancelDeleteBtn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

<script>
// === Ø¹Ù†Ø§ØµØ± DOM ===
const returnsTableBody = document.getElementById("returnsTableBody");
const addNewReturnBtn = document.getElementById('addNewReturnBtn');
const returnModal = document.getElementById('returnModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const saveReturnBtn = document.getElementById('saveReturnBtn');
const modalTitle = document.getElementById('modalTitle');
const returnForm = document.getElementById('returnForm');

const deleteModal = document.getElementById('deleteModal');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

// Ø­Ù‚Ù„ Ù…Ø®ÙÙŠ Ù„ØªØ®Ø²ÙŠÙ† ID Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡
const returnIdInput = document.getElementById('returnId');
let currentEditingRow = null; 

// === ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù€ Modal ===
function openModal(mode, row = null) {
    returnForm.reset(); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹

    if (mode === "add") {
        modalTitle.textContent = "Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯";
        returnIdInput.value = "";
        currentEditingRow = null;
    } else if (mode === "edit" && row) {
        modalTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹";
        currentEditingRow = row;
        const data = extractRowData(row);
        
        // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù€ Modal Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ
        document.getElementById('returnId').value = data.id;
        document.getElementById('imageUrl').value = data.imageUrl;
        document.getElementById('productName').value = data.name;
        document.getElementById('productCode').value = data.code;
        document.getElementById('quantity').value = data.quantity;
        document.getElementById('buyPrice').value = data.buyPrice;
        document.getElementById('retailPrice').value = data.retailPrice;
        document.getElementById('wholesalePrice').value = data.wholesalePrice;
        document.getElementById('reason').value = data.reason;
    }
    returnModal.classList.remove('hidden');
}

function closeModal() {
    returnModal.classList.add('hidden');
    returnForm.reset();
    currentEditingRow = null;
    returnIdInput.value = "";
}

function openDeleteModal(id) {
    returnIdInput.value = id;
    deleteModal.classList.remove('hidden');
}

function closeDeleteModal() {
    deleteModal.classList.add('hidden');
    returnIdInput.value = "";
}


// ÙˆØ¸ÙŠÙØ© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…ÙÙŠØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
function extractRowData(row) {
    const cells = row.querySelectorAll('td');
    return {
        id: row.getAttribute('data-id'),
        imageUrl: cells[0].querySelector('img').src,
        code: cells[1].textContent,
        name: cells[2].textContent,
        quantity: parseInt(cells[3].textContent),
        buyPrice: parseFloat(cells[4].textContent.replace(' Ø¬.Ù…', '')),
        retailPrice: parseFloat(cells[5].textContent.replace(' Ø¬.Ù…', '')),
        wholesalePrice: parseFloat(cells[6].textContent.replace(' Ø¬.Ù…', '')),
        reason: cells[8].textContent
    };
}


// === Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Flask API (Backend Simulation) ===

/**
 * Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©.
 * @async
 */
async function loadReturns() {
    try {
        // ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙƒÙˆÙƒÙŠØ² (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Flask ÙŠØ¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)
        const res = await fetch("/api/returns", {
            method: "GET",
            credentials: "include"
        });

        if (!res.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${res.status}`);
        }

        const data = await res.json();
        renderReturnsTable(data);
    } catch (err) {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        returnsTableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4 text-red-500">
                    âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ.
                </td>
            </tr>`;
    }
}


/**
 * Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
 * @param {Array} items - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª.
 */
function renderReturnsTable(items) {
    returnsTableBody.innerHTML = "";
    items.forEach(item => {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹ÙŠ ÙˆØ³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
        const profit = (item.retail_price - item.cost_price) * item.quantity;
        const profitText = `${profit >= 0 ? '+' : ''}${profit.toFixed(2)} Ø¬.Ù…`;
        const profitClass = profit >= 0 ? 'text-green-600' : 'text-red-600';

        const newRow = returnsTableBody.insertRow();
        newRow.setAttribute('data-id', item.id);
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap"><img src="${item.image_url || 'https://via.placeholder.com/50'}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.code || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.cost_price.toFixed(2)} Ø¬.Ù…</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.retail_price.toFixed(2)} Ø¬.Ù…</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.wholesale_price.toFixed(2)} Ø¬.Ù…</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${profitClass}">${profitText}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.reason || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="edit-btn text-blue-600 hover:text-blue-900 ml-4" data-id="${item.id}"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="delete-btn text-red-600 hover:text-red-900" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
            </td>
        `;
    });
}


/**
 * Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„) Ù…Ø±ØªØ¬Ø¹.
 * @async
 * @param {Object} data - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹.
 * @param {boolean} isEdit - Ù‡Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø£Ù… Ø¥Ø¶Ø§ÙØ©ØŸ
 * @param {string} id - ID Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.
 */
async function saveReturn(data, isEdit = false, id = null) {
    const url = isEdit ? `/api/returns/${id}` : "/api/returns";
    const method = isEdit ? "PUT" : "POST";

    try {
        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            alert(isEdit ? "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!" : "âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!");
            loadReturns();
        } else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯ Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
            const errorData = await res.json().catch(() => ({ message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }));
            alert(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${res.status}. Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${errorData.message || 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù….'}`);
        }
    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯:", err);
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.");
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹.
 * @async
 * @param {string} id - ID Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡.
 */
async function deleteReturn(id) {
    try {
        const res = await fetch(`/api/returns/${id}`, { method: "DELETE" });
        if (res.ok) {
            alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­!");
            loadReturns();
        } else {
            const errorData = await res.json().catch(() => ({ message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }));
            alert(`âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù. Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${res.status}. Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${errorData.message || 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù….'}`);
        }
    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯:", err);
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.");
    }
}

// === Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
document.addEventListener("DOMContentLoaded", () => {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadReturns();

    // ÙØªØ­ Modal Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    addNewReturnBtn.addEventListener('click', () => openModal("add"));
    
    // Ø¥ØºÙ„Ø§Ù‚ Modal Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    closeModalBtn.addEventListener('click', closeModal);

    // Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„)
    saveReturnBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const data = {
            image_url: document.getElementById('imageUrl').value || 'https://via.placeholder.com/50',
            name: document.getElementById('productName').value,
            code: document.getElementById('productCode').value, // Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ù…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙƒÙ€ ID ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯)
            quantity: parseInt(document.getElementById('quantity').value),
            cost_price: parseFloat(document.getElementById('buyPrice').value || 0),
            retail_price: parseFloat(document.getElementById('retailPrice').value || 0),
            wholesale_price: parseFloat(document.getElementById('wholesalePrice').value || 0),
            reason: document.getElementById('reason').value
        };

        const id = document.getElementById('returnId').value;
        const isEdit = !!id; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ IDØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ ØªØ¹Ø¯ÙŠÙ„

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!data.name || !data.code || isNaN(data.quantity) || data.quantity < 1) {
            alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù…Ø²ØŒ Ø§Ù„ÙƒÙ…ÙŠØ©).");
            return;
        }

        await saveReturn(data, isEdit, id);
        closeModal();
    });

    // Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Event Delegation)
    returnsTableBody.addEventListener("click", (e) => {
        const deleteButton = e.target.closest(".delete-btn");
        const editButton = e.target.closest(".edit-btn");
        
        if (deleteButton) {
            const id = deleteButton.getAttribute("data-id");
            openDeleteModal(id);
        } else if (editButton) {
            const row = editButton.closest("tr");
            openModal("edit", row);
        }
    });

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    confirmDeleteBtn.addEventListener('click', async () => {
        const idToDelete = returnIdInput.value;
        if (idToDelete) {
            await deleteReturn(idToDelete);
            closeDeleteModal();
        }
    });

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø°Ù
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
});
</script>

</body>
</html>